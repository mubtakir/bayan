// ============================================================================
// ðŸŽ¯ ÙˆØ­Ø¯Ø© Ø§Ù„Ù†ÙˆØ§Ø© - Core Module
// ============================================================================
// Ù…Ù†Ø³Ù‘Ù‚ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ

use types;
use nlu;
use nlg;
use optimizer;
use bridge;

// ============================================================================
// 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// ============================================================================

fn process_input(agent: mut BayanAgent, input: string, bayan_bridge: bridge::BayanBridge) -> Response {
    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ÙŠØ©
    let intent = nlu::parse_intent(input);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙŠØ©
    let response = handle_intent(agent, intent, bayan_bridge);

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«
    let event = types::create_event(intent.intent, response.ok);
    optimizer::observe_event(agent, event);

    return response;
}

// ============================================================================
// 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ÙŠØ©
// ============================================================================

fn handle_intent(agent: mut BayanAgent, intent: types::Intent, bayan_bridge: bridge::BayanBridge) -> Response {
    if intent.intent == "run" {
        return handle_run(agent, intent, bayan_bridge);
    } else if intent.intent == "compile" {
        return handle_compile(agent, intent, bayan_bridge);
    } else if intent.intent == "analyze" {
        return handle_analyze(agent, intent, bayan_bridge);
    } else if intent.intent == "suggest" {
        return handle_suggest(agent, intent);
    } else if intent.intent == "chat" {
        return handle_chat(agent, intent);
    } else {
        return types::create_response("error", "âŒ Ù†ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©", false);
    }
}

// ============================================================================
// 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
// ============================================================================

fn handle_run(agent: mut BayanAgent, intent: types::Intent, bayan_bridge: bridge::BayanBridge) -> Response {
    if intent.target.len() == 0 {
        return types::create_response("run", "âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù Ù„Ù„ØªØ´ØºÙŠÙ„", false);
    }

    let response = bridge::run_file(bayan_bridge, intent.target);
    return response;
}

// ============================================================================
// 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø©
// ============================================================================

fn handle_compile(agent: mut BayanAgent, intent: types::Intent, bayan_bridge: bridge::BayanBridge) -> Response {
    if intent.target.len() == 0 {
        return types::create_response("compile", "âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù Ù„Ù„ØªØ±Ø¬Ù…Ø©", false);
    }

    let response = bridge::compile_file(bayan_bridge, intent.target);
    return response;
}

// ============================================================================
// 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„
// ============================================================================

fn handle_analyze(agent: mut BayanAgent, intent: types::Intent, bayan_bridge: bridge::BayanBridge) -> Response {
    if intent.code.len() == 0 {
        return types::create_response("analyze", "âŒ ÙŠØ±Ø¬Ù‰ ØªÙˆÙÙŠØ± ÙƒÙˆØ¯ Ù„Ù„ØªØ­Ù„ÙŠÙ„", false);
    }

    let response = bridge::analyze_code(bayan_bridge, intent.code);
    return response;
}

// ============================================================================
// 6. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
// ============================================================================

fn handle_suggest(agent: mut BayanAgent, intent: types::Intent) -> Response {
    let suggestions = optimizer::propose_optimizations(agent);

    let text = nlg::generate_reply(agent.config.language, "suggest", suggestions);
    let response = types::create_response("suggest", text, true);
    response.data = suggestions;

    return response;
}

// ============================================================================
// 7. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
// ============================================================================

fn handle_chat(agent: mut BayanAgent, intent: types::Intent) -> Response {
    let text = nlg::generate_reply(agent.config.language, "chat", []);
    return types::create_response("chat", text, true);
}

// ============================================================================
// 8. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø§ØµØ©
// ============================================================================

fn handle_special_command(agent: mut BayanAgent, command: string) -> Response {
    if command == "help" {
        let text = nlg::generate_help_message(agent.config.language);
        return types::create_response("help", text, true);
    } else if command == "status" {
        let text = optimizer::get_event_summary(agent);
        return types::create_response("status", text, true);
    } else if command == "reset" {
        optimizer::reset_events(agent);
        let text = "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«";
        return types::create_response("reset", text, true);
    } else {
        return types::create_response("error", "âŒ Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", false);
    }
}

// ============================================================================
// 9. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
// ============================================================================

fn get_welcome_message(agent: BayanAgent) -> string {
    return nlg::generate_welcome_message(agent.config.language);
}

// ============================================================================
// 10. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ¯Ø§Ø¹
// ============================================================================

fn get_goodbye_message(agent: BayanAgent) -> string {
    if agent.config.language == "ar" {
        return "ðŸ‘‹ ÙˆØ¯Ø§Ø¹Ø§Ù‹! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙƒÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†.";
    } else {
        return "ðŸ‘‹ Goodbye! Thank you for using AlBayan Agent.";
    }
}

// ============================================================================
// Ù†Ù‡Ø§ÙŠØ© ÙˆØ­Ø¯Ø© Core
// ============================================================================

