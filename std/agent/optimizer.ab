// ============================================================================
// âš¡ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù† - Optimizer Module
// ============================================================================
// ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„ØªØ­Ø³ÙŠÙ†

use types;

// ============================================================================
// 1. ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯
// ============================================================================

fn observe_event(agent: mut BayanAgent, event: Event) {
    agent.events.push(event);
}

// ============================================================================
// 2. Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ============================================================================

fn count_events_by_intent(agent: BayanAgent, intent: string) -> int {
    let count = 0;
    let i = 0;

    while i < agent.events.len() {
        let event = agent.events[i];
        if event.intent == intent {
            count = count + 1;
        }
        i = i + 1;
    }

    return count;
}

// ============================================================================
// 3. Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­
// ============================================================================

fn calculate_success_rate(agent: BayanAgent, intent: string) -> int {
    let total = count_events_by_intent(agent, intent);
    if total == 0 {
        return 0;
    }

    let success = 0;
    let i = 0;

    while i < agent.events.len() {
        let event = agent.events[i];
        if event.intent == intent && event.ok {
            success = success + 1;
        }
        i = i + 1;
    }

    return (success * 100) / total;
}

// ============================================================================
// 4. ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
// ============================================================================

fn propose_optimizations(agent: BayanAgent) -> list<string> {
    let suggestions = [];

    // Ø§Ù‚ØªØ±Ø§Ø­ 1: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ´Ù„ Ø¹Ø§Ù„ÙŠØ§Ù‹
    let compile_rate = calculate_success_rate(agent, "compile");
    if compile_rate < 50 && compile_rate > 0 {
        suggestions.push("âš ï¸ Ù…Ø¹Ø¯Ù„ ÙØ´Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù…Ø±ØªÙØ¹. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©.");
    }

    // Ø§Ù‚ØªØ±Ø§Ø­ 2: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    let analyze_count = count_events_by_intent(agent, "analyze");
    if analyze_count > 10 {
        suggestions.push("ğŸ’¡ Ù„Ø¯ÙŠÙƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¢Ù„ÙŠØ©.");
    }

    // Ø§Ù‚ØªØ±Ø§Ø­ 3: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯
    if agent.events.len() > 0 && compile_rate > 80 {
        suggestions.push("âœ… Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±.");
    }

    // Ø§Ù‚ØªØ±Ø§Ø­ 4: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†Ø´Ø§Ø·
    if agent.events.len() == 0 {
        suggestions.push("ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø¨Ø¯Ø£ Ø¨ØªØ´ØºÙŠÙ„ Ø£Ùˆ ØªØ±Ø¬Ù…Ø© Ù…Ù„Ù.");
    }

    return suggestions;
}

// ============================================================================
// 5. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ============================================================================

fn get_event_summary(agent: BayanAgent) -> string {
    let total = agent.events.len();
    let run_count = count_events_by_intent(agent, "run");
    let compile_count = count_events_by_intent(agent, "compile");
    let analyze_count = count_events_by_intent(agent, "analyze");

    let summary = "ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:\n";
    summary = summary + "  Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: " + total + "\n";
    summary = summary + "  Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„: " + run_count + "\n";
    summary = summary + "  Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©: " + compile_count + "\n";
    summary = summary + "  Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + analyze_count;

    return summary;
}

// ============================================================================
// 6. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ============================================================================

fn reset_events(agent: mut BayanAgent) {
    agent.events = [];
}

// ============================================================================
// 7. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø­Ø¯Ø«
// ============================================================================

fn get_last_event(agent: BayanAgent) -> Event {
    if agent.events.len() > 0 {
        return agent.events[agent.events.len() - 1];
    }

    return types::create_event("none", false);
}

// ============================================================================
// 8. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡
// ============================================================================

fn is_performing_well(agent: BayanAgent) -> bool {
    if agent.events.len() < 5 {
        return false;
    }

    let compile_rate = calculate_success_rate(agent, "compile");
    let run_rate = calculate_success_rate(agent, "run");

    if compile_rate > 70 && run_rate > 70 {
        return true;
    }

    return false;
}

// ============================================================================
// Ù†Ù‡Ø§ÙŠØ© ÙˆØ­Ø¯Ø© Optimizer
// ============================================================================

