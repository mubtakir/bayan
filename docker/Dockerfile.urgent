# ğŸš€ Dockerfile Ø¹Ø§Ø¬Ù„ Ù„Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†
# Urgent AlBayan Docker Image

FROM rust:1.75-slim as builder

# ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    llvm-15-dev \
    libclang-15-dev \
    pkg-config \
    libssl-dev \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV LLVM_SYS_150_PREFIX=/usr/lib/llvm-15
ENV LIBCLANG_PATH=/usr/lib/llvm-15/lib

# Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ
WORKDIR /app
COPY . .

# Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ØªØ±Ø¬Ù…
RUN cargo build --release --bin albayan

# Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
FROM ubuntu:22.04

# ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ´ØºÙŠÙ„
RUN apt-get update && apt-get install -y \
    llvm-15-runtime \
    libssl3 \
    ca-certificates \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø°Ø±
RUN useradd -m -s /bin/bash albayan

# Ù†Ø³Ø® Ø§Ù„Ù…ØªØ±Ø¬Ù… Ù…Ù† Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
COPY --from=builder /app/target/release/albayan /usr/local/bin/albayan

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„
RUN mkdir -p /workspace /examples /projects
RUN chown -R albayan:albayan /workspace /examples /projects

# Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø«Ù„Ø©
COPY examples/ /examples/
RUN chown -R albayan:albayan /examples

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV PATH="/usr/local/bin:$PATH"
ENV ALBAYAN_HOME="/usr/local"

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø§Ù„Ø¬Ø°Ø±
USER albayan
WORKDIR /workspace

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«Ø§Ù„ ØªØ±Ø­ÙŠØ¨ÙŠ
RUN echo '// Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†!' > /workspace/welcome.ab && \
    echo '// Welcome to AlBayan Programming Language!' >> /workspace/welcome.ab && \
    echo '' >> /workspace/welcome.ab && \
    echo 'fn main() -> int {' >> /workspace/welcome.ab && \
    echo '    print("ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†!");' >> /workspace/welcome.ab && \
    echo '    print("ğŸš€ Ø£ÙˆÙ„ Ù„ØºØ© Ø¨Ø±Ù…Ø¬Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¯Ù…Ø¬!");' >> /workspace/welcome.ab && \
    echo '    print("");' >> /workspace/welcome.ab && \
    echo '    print("ğŸ§¬ Ù…ÙŠØ²Ø§Øª Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†:");' >> /workspace/welcome.ab && \
    echo '    print("  âœ… Ø¨Ø±Ù…Ø¬Ø© ØªÙ‚Ù„ÙŠØ¯ÙŠØ© + Ù…Ù†Ø·Ù‚ÙŠØ©");' >> /workspace/welcome.ab && \
    echo '    print("  âœ… Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¯Ù…Ø¬");' >> /workspace/welcome.ab && \
    echo '    print("  âœ… Ø£Ø¯Ø§Ø¡ Ø¹Ø§Ù„ÙŠ Ù…Ø¹ Rust + LLVM");' >> /workspace/welcome.ab && \
    echo '    print("  âœ… Ø¯Ø¹Ù… TensorFlow ÙˆPyTorch ÙˆONNX");' >> /workspace/welcome.ab && \
    echo '    print("");' >> /workspace/welcome.ab && \
    echo '    print("ğŸ”¥ Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©!");' >> /workspace/welcome.ab && \
    echo '    print("ğŸ³ ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ Docker Container!");' >> /workspace/welcome.ab && \
    echo '    print("");' >> /workspace/welcome.ab && \
    echo '    print("ğŸ“š Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ù…ØªÙˆÙØ±Ø© ÙÙŠ: /examples/");' >> /workspace/welcome.ab && \
    echo '    print("ğŸ’» Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„: /workspace/");' >> /workspace/welcome.ab && \
    echo '    print("ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†: albayan run welcome.ab");' >> /workspace/welcome.ab && \
    echo '    ' >> /workspace/welcome.ab && \
    echo '    return 0;' >> /workspace/welcome.ab && \
    echo '}' >> /workspace/welcome.ab

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
COPY docker/entrypoint.sh /entrypoint.sh
USER root
RUN chmod +x /entrypoint.sh
USER albayan

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
ENTRYPOINT ["/entrypoint.sh"]
CMD ["albayan", "run", "welcome.ab"]

# Ø¥Ø¶Ø§ÙØ© ØªØ³Ù…ÙŠØ§Øª
LABEL maintainer="AlBayan Team <team@albayan.dev>"
LABEL version="1.0.0-urgent"
LABEL description="Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù† - Ø£ÙˆÙ„ Ù„ØºØ© Ø¨Ø±Ù…Ø¬Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¯Ù…Ø¬"
LABEL org.opencontainers.image.title="AlBayan Programming Language"
LABEL org.opencontainers.image.description="First Arabic programming language with built-in AI"
LABEL org.opencontainers.image.url="https://github.com/mubtakir/bayan"
LABEL org.opencontainers.image.source="https://github.com/mubtakir/bayan"
LABEL org.opencontainers.image.vendor="AlBayan Team"
LABEL org.opencontainers.image.licenses="MIT"

# Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµØ­Ø©
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD albayan --version || exit 1

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©
VOLUME ["/workspace", "/projects"]

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†Ø§ÙØ° (Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©)
EXPOSE 8080 3000

# Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©
RUN echo "ğŸ”¥ Docker Image Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ!" && \
    echo "âš¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¹Ø§Ø¬Ù„Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ù…Ø§Ù‡ÙŠØ±!" && \
    echo "ğŸš€ Ù„ØºØ© Ø§Ù„Ø¨ÙŠØ§Ù† - Ø³Ø±Ø¹Ø© + Ù‚ÙˆØ© + Ø¥Ø¨Ø¯Ø§Ø¹!"
